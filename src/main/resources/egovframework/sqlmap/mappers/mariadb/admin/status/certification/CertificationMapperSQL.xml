<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seegene.web.repository.mariadb.CertificationMapper">


	<!-- 인증현황 단일 조회 -->
	<select id="findCertificationBySeq" parameterType="HashMap" resultType="CertificationVO">
		SELECT *
		FROM TDAA_CERTIFICATION
		WHERE SEQ = #{seq}
	</select>
	
	
	<!--  인증현황 관리 리스트 -->
	<select id="findCertificationList" parameterType="HashMap" resultType="CertificationListRO" >
		SELECT @ROWNUM:=@ROWNUM+1 as row, 
			ta.SEQ,
			(
				SELECT tba.SLAVE_CODE_NAME
				FROM TABB_CODE_SLAVE tba
				WHERE tba.MASTER_CODE = 'cert'
				AND tba.DELETE_FLAG = 'N'
				AND tba.SLAVE_CODE = ta.CODE_CERT_TYPE
			) as CODE_CERT_NAME,
			(
				SELECT tba.SLAVE_CODE_NAME
				FROM TABB_CODE_SLAVE tba
				WHERE tba.MASTER_CODE = 'center'
				AND tba.DELETE_FLAG = 'N'
				AND tba.SLAVE_CODE = ta.CODE_CENTER_TYPE
			) as CODE_CENTER_NAME,
			CASE
				WHEN ta.CODE_CERT_LOC_TYPE IS NULL THEN ''
				ELSE (
					SELECT tba.SLAVE_CODE_NAME
					FROM TABB_CODE_SLAVE tba
					WHERE tba.MASTER_CODE = 'certLoc'
					AND tba.DELETE_FLAG = 'N'
					AND tba.SLAVE_CODE = ta.CODE_CERT_LOC_TYPE
				)
			END as CODE_CERT_LOC_NAME,
			ta.TITLE, 
			ta.PRINT_FLAG, 
			ta.PRINT_ORDER,
			(
				SELECT tba.SLAVE_CODE_NAME
				FROM TABB_CODE_SLAVE tba
				WHERE tba.MASTER_CODE = 'lang'
				AND tba.DELETE_FLAG = 'N'
				AND tba.SLAVE_CODE = ta.CODE_LANG_TYPE
			) as CODE_LANG_NAME,
			ta.EDIT_DATE 
		FROM TDAA_CERTIFICATION ta,
		(SELECT @ROWNUM := #{offset}) TMP
		WHERE ta.DELETE_FLAG = 'N'
		<if test="searchKeyword !=null and ! searchKeyword.equals('')">
			<choose>
				<when test="searchOption != null and searchOption.equals('title')">
					AND ta.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchOption != null and searchOption.equals('content')">
					AND ta.CONTENT LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<otherwise>
					AND (
							ta.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
						OR
							ta.CONTENT LIKE CONCAT('%', #{searchKeyword}, '%')
					)
				</otherwise>
			</choose>
		</if>
		ORDER BY ta.CODE_CENTER_TYPE desc , ta.CODE_CERT_TYPE desc , ta.CODE_CERT_LOC_TYPE asc, PRINT_ORDER
		
		LIMIT #{limit} OFFSET #{offset}
	
	</select>
	
	
	<!-- 인증현황 관리 리스트 카운트 -->
	<select id="countCertificationList" parameterType="HashMap" resultType="Integer">
		SELECT COUNT(1) CNT
		FROM TDAA_CERTIFICATION ta
		WHERE ta.DELETE_FLAG = 'N'
		<if test="searchKeyword !=null and ! searchKeyword.equals('')">
			<choose>
				<when test="searchOption != null and searchOption.equals('title')">
					AND ta.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchOption != null and searchOption.equals('content')">
					AND ta.CONTENT LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<otherwise>
					AND (
							ta.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
						OR
							ta.CONTENT LIKE CONCAT('%', #{searchKeyword}, '%')
					)
				</otherwise>
			</choose>
		</if>
	</select>
	
	<!-- 인증현황 기본 정보 상세 조회용 -->
	<select id="findCertificationViewBySeq" parameterType="hashmap" resultType="certificationViewRO">
		SELECT ta.SEQ, 
			ta.CODE_LANG_TYPE,
			(
				SELECT tba.SLAVE_CODE_NAME
				FROM TABB_CODE_SLAVE tba
				WHERE tba.MASTER_CODE = 'lang'
				AND tba.DELETE_FLAG = 'N'
				AND tba.SLAVE_CODE = ta.CODE_LANG_TYPE
			) as CODE_LANG_NAME,
			ta.CODE_CERT_TYPE,
			(
				SELECT tba.SLAVE_CODE_NAME
				FROM TABB_CODE_SLAVE tba
				WHERE tba.MASTER_CODE = 'cert'
				AND tba.DELETE_FLAG = 'N'
				AND tba.SLAVE_CODE = ta.CODE_CERT_TYPE
			) as CODE_CERT_NAME,
			ta.CODE_CENTER_TYPE,
			(
				SELECT tba.SLAVE_CODE_NAME
				FROM TABB_CODE_SLAVE tba
				WHERE tba.MASTER_CODE = 'center'
				AND tba.DELETE_FLAG = 'N'
				AND tba.SLAVE_CODE = ta.CODE_CENTER_TYPE
			) as CODE_CENTER_NAME,
			
			ta.CODE_CERT_LOC_TYPE,
			CASE
				WHEN ta.CODE_CERT_LOC_TYPE IS NULL THEN ''
				ELSE (
					SELECT tba.SLAVE_CODE_NAME
					FROM TABB_CODE_SLAVE tba
					WHERE tba.MASTER_CODE = 'certLoc'
					AND tba.DELETE_FLAG = 'N'
					AND tba.SLAVE_CODE = ta.CODE_CERT_LOC_TYPE
				)
			END as CODE_CERT_LOC_NAME,
			
			ta.TITLE,
			ta.ISSUING_AGENCY,
			ta.CONTENT,
			ta.FILE_PATH,
			ta.THUM_FILE_PATH,
			ta.PRINT_FLAG,
			ta.PRINT_ORDER,
			ta.EDIT_DATE,
			ta.EDIT_USER_ID,
			(SELECT NAME from TAAA_ADMIN_USER WHERE USER_ID = ta.EDIT_USER_ID) as EDIT_USER_NAME
		FROM TDAA_CERTIFICATION ta
		WHERE DELETE_FLAG = 'N'
		AND SEQ = #{seq}
	</select>
	
	<!-- 언어코드에 따른 갯수 -->
	<select id="getPrintOrder" parameterType="HashMap" resultType="Integer">
		SELECT COUNT(1) as CNT
		FROM TDAA_CERTIFICATION
		WHERE DELETE_FLAG = 'N'
		AND CODE_LANG_TYPE = #{codeLangType}
		AND CODE_CERT_TYPE = #{codeCertType}
		AND CODE_CERT_LOC_TYPE = #{codeCertLocType}
		AND CODE_CENTER_TYPE = #{codeCenterType}
	</select>
	
	
	<!-- 인증현황 로그 용 -->	
	<select id="checkCertificationOrder" parameterType="HashMap" resultType="CertificationVO">
		SELECT *
		FROM TDAA_CERTIFICATION
		WHERE DELETE_FLAG = 'N'
		AND PRINT_ORDER >= #{printOrder}
		AND CODE_LANG_TYPE = #{codeLangType}
		AND CODE_CERT_TYPE = #{codeCertType}
		AND CODE_CERT_LOC_TYPE = #{codeCertLocType}
		AND CODE_CENTER_TYPE = #{codeCenterType}
	</select>
	
	<!-- 인증현황 출력 순서 증가 업데이트 -->
	<update id="updateCertificationOrderInc" parameterType="HashMap">
		UPDATE TDAA_CERTIFICATION
		SET PRINT_ORDER= PRINT_ORDER+1,
			EDIT_DATE = now(),
			EDIT_USER_ID = #{editUserId}
		WHERE DELETE_FLAG = 'N'
		AND PRINT_ORDER >= #{printOrder}
		AND CODE_LANG_TYPE = #{codeLangType}
		AND CODE_CERT_TYPE = #{codeCertType}
		AND CODE_CERT_LOC_TYPE = #{codeCertLocType}
		AND CODE_CENTER_TYPE = #{codeCenterType}
	</update>
	
	<!-- 인증현황 출력 순서 감소 업데이트 -->
	<update id="updateCertificationOrderDec" parameterType="HashMap">
		UPDATE TDAA_CERTIFICATION
		SET PRINT_ORDER= PRINT_ORDER-1,
			EDIT_DATE = now(),
			EDIT_USER_ID = #{editUserId}
		WHERE DELETE_FLAG = 'N'
		AND PRINT_ORDER >= #{printOrder}
		AND CODE_LANG_TYPE = #{codeLangType}
		AND CODE_CERT_TYPE = #{codeCertType}
		AND CODE_CERT_LOC_TYPE = #{codeCertLocType}
		AND CODE_CENTER_TYPE = #{codeCenterType}
	</update>
	

	
	<!-- 인증현황 등록 -->
	<insert id="addCertification" parameterType="HashMap"  useGeneratedKeys="true" keyProperty="seq">
	INSERT INTO TDAA_CERTIFICATION
	(
	    CODE_LANG_TYPE,
	    TITLE,
	    ISSUING_AGENCY,
	    CODE_CERT_TYPE,
	    CODE_CENTER_TYPE,
	    CODE_CERT_LOC_TYPE,
	    CONTENT,
	    FILE_PATH,
	    FILE_NAME,
	    THUM_FILE_PATH,
	    PRINT_FLAG,
	    PRINT_ORDER,
	    EDIT_USER_ID,
	    REG_USER_ID,
	    REG_DATE,
	    EDIT_DATE,
	    DELETE_FLAG    
	)
	VALUES
	(
		#{codeLangType},
		#{title},
		#{issuingAgency},
		#{codeCertType},
		#{codeCenterType},
		#{codeCertLocType},
		#{content}, 
		#{filePath},
		#{fileName},
		#{thumFilePath},
		#{printFlag},
		#{printOrder},
		#{regUserId},
		#{regUserId},
		now(),
		now(),
		'N'
	)
	</insert>
	
	
	
	<!-- 인증현황 수정 -->
	<update id="editCertification" parameterType="HashMap">
		UPDATE TDAA_CERTIFICATION
		SET 
			CODE_LANG_TYPE= #{codeLangType},
			TITLE= #{title},
			ISSUING_AGENCY= #{issuingAgency},
			CODE_CERT_TYPE= #{codeCertType},
			CODE_CENTER_TYPE= #{codeCenterType},
			CODE_CERT_LOC_TYPE = #{codeCertLocType},
			CONTENT= #{content},
			
			FILE_PATH= #{filePath},
			FILE_NAME= #{fileName},
			THUM_FILE_PATH=  #{thumFilePath},
			
			PRINT_FLAG= #{printFlag},
			PRINT_ORDER= #{printOrder},
			
			EDIT_DATE = now(),
			EDIT_USER_ID = #{editUserId}
		WHERE DELETE_FLAG = 'N'
		AND SEQ = #{seq}
	</update>
	
	<!-- 인증현황 삭제 -->
	<update id="deleteCertification" parameterType="HashMap">
		UPDATE TDAA_CERTIFICATION
		SET DELETE_FLAG = 'Y',
			PRINT_FLAG = 'N',
			EDIT_DATE = now(),
			EDIT_USER_ID = #{editUserId}
		WHERE DELETE_FLAG = 'N'
		AND SEQ = #{seq}
	</update>
	
	
	
	<!-- 사용자용 -->
	<!-- 사용자 인증현황  리스트 -->
	<select id="findUserCertificationList" parameterType="HashMap" resultType="certListRO" >
		SELECT  
			ta.SEQ,
			ta.TITLE,
			ta.ISSUING_AGENCY,
			ta.CONTENT,
			ta.CODE_CERT_LOC_TYPE,
			ta.CODE_CERT_TYPE,
			ta.PRINT_ORDER,
			ta.THUM_FILE_PATH
		FROM TDAA_CERTIFICATION ta
		WHERE ta.DELETE_FLAG = 'N'
		AND ta.PRINT_FLAG = 'Y'

		AND ta.CODE_CENTER_TYPE = #{codeCenterType}
		AND ta.CODE_LANG_TYPE = #{codeLangType}
		<if test="searchKeyword !=null and ! searchKeyword.equals('')">
			AND (
					ta.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
				OR
					ta.CONTENT LIKE CONCAT('%', #{searchKeyword}, '%')
			)
		</if>
		ORDER BY ta.CODE_CENTER_TYPE desc , ta.CODE_CERT_TYPE desc , ta.CODE_CERT_LOC_TYPE asc, PRINT_ORDER
		
		LIMIT #{limit} OFFSET #{offset}
	
	</select>
	
	
	<!-- 사용자 인증현황 리스트 카운트 -->
	<select id="countUserCertificationList" parameterType="HashMap" resultType="Integer">
		SELECT COUNT(1) CNT
		FROM TDAA_CERTIFICATION ta
		WHERE ta.DELETE_FLAG = 'N'
		AND ta.PRINT_FLAG = 'Y'

		AND ta.CODE_CENTER_TYPE = #{codeCenterType}
		AND ta.CODE_LANG_TYPE = #{codeLangType}
		<if test="searchKeyword !=null and ! searchKeyword.equals('')">
			AND (
					ta.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
				OR
					ta.CONTENT LIKE CONCAT('%', #{searchKeyword}, '%')
			)
		</if>
	</select>
	
	<!-- 인증현황 파일 다운로드용 -->
	<select id="findUserCertificationFileBySeq" parameterType="hashmap" resultType="CertificationVO">
		SELECT 
			ta.FILE_PATH,
			ta.FILE_NAME
		FROM TDAA_CERTIFICATION ta
		WHERE DELETE_FLAG = 'N'
		AND SEQ = #{seq}
		AND ta.PRINT_FLAG = 'Y'
	</select>
	
	

</mapper>