<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seegene.web.repository.mariadb.ErrorLogMapper">

	<insert id="insertErrorLog" parameterType="logErrorVO">
		INSERT INTO TZCA_LOG_ERROR
			(
				URL, 
				MENU_NAME, 
				IP, 
				PARAM_JSON, 
				ERROR_MSG,
				REG_DATE,
				REG_USER_ID)
		VALUES(#{url}, #{menuName}, #{ip}, #{paramJson},  #{errorMsg}, now(), #{regUserId})
	</insert>
	


	<!-- 에러 로그 리스트 -->
	<select id="findErrorLogList" parameterType="HashMap" resultType="logErrorListRO" >
		SELECT @ROWNUM:=@ROWNUM+1 as row, 
			ta.SEQ,
			ta.URL, 
			ta.MENU_NAME, 
			ta.REG_USER_ID,
			CASE
				WHEN ta.REG_USER_ID is null then ''
				ELSE (SELECT NAME from TAAA_ADMIN_USER WHERE USER_ID = ta.REG_USER_ID)
			END as REG_USER_NAME,
			ta.IP,
			ta.REG_DATE 
		FROM TZCA_LOG_ERROR ta,
		(SELECT @ROWNUM := #{offset}) TMP
		WHERE 1=1
		<if test="startDate !=null and ! startDate.equals('')">
		AND ta.REG_DATE >= #{startDate}
		</if>
		<if test="endDate !=null and ! endDate.equals('')">
		AND #{endDate} >= ta.REG_DATE
		</if>
		<if test="searchKeyword !=null and ! searchKeyword.equals('')">
			<choose>
				<when test="searchOption != null and searchOption.equals('menu')">
					AND ta.MENU_NAME LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchOption != null and searchOption.equals('userId')">
					AND ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<otherwise>
					AND (
							ta.MENU_NAME LIKE CONCAT('%', #{searchKeyword}, '%')
						OR
							ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
					)
				</otherwise>
			</choose>
		</if>
		ORDER BY REG_DATE DESC
		
		LIMIT #{limit} OFFSET #{offset}
	</select>
	
	<!-- 에러 로그 리스트 카운트 -->
	<select id="countErrorLogList" parameterType="HashMap" resultType="Integer">
		SELECT COUNT(1) CNT
		FROM TZCA_LOG_ERROR ta
		WHERE 1=1
		<if test="startDate !=null and ! startDate.equals('')">
		AND ta.REG_DATE >= #{startDate}
		</if>
		<if test="endDate !=null and ! endDate.equals('')">
		AND #{endDate} >= ta.REG_DATE
		</if>
		<if test="searchKeyword !=null and ! searchKeyword.equals('')">
			<choose>
				<when test="searchOption != null and searchOption.equals('menu')">
					AND ta.MENU_NAME LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchOption != null and searchOption.equals('userId')">
					AND ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<otherwise>
					AND (
							ta.MENU_NAME LIKE CONCAT('%', #{searchKeyword}, '%')
						OR
							ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
					)
				</otherwise>
			</choose>
		</if>
	</select>
	
	<select id="findDownloadErrorLogList" parameterType="HashMap" resultType="logErrorViewRO" >
		SELECT  
			ta.SEQ,
			ta.URL, 
			ta.MENU_NAME, 
			ta.PARAM_JSON,
			ta.ERROR_MSG,
			ta.REG_USER_ID,
			CASE
				WHEN ta.REG_USER_ID is null then ''
				WHEN (SELECT count(1) from TAAA_ADMIN_USER WHERE USER_ID = ta.REG_USER_ID) = 0 then ''
				ELSE (SELECT NAME from TAAA_ADMIN_USER WHERE USER_ID = ta.REG_USER_ID)
			END as REG_USER_NAME,
			ta.IP,
			ta.REG_DATE 
		FROM TZCA_LOG_ERROR ta,
		(SELECT @ROWNUM := #{offset}) TMP
		WHERE 1=1
		<if test="startDate !=null and ! startDate.equals('')">
		AND ta.REG_DATE >= #{startDate}
		</if>
		<if test="endDate !=null and ! endDate.equals('')">
		AND #{endDate} >= ta.REG_DATE
		</if>
		<if test="searchKeyword !=null and ! searchKeyword.equals('')">
			<choose>
				<when test="searchOption != null and searchOption.equals('menu')">
					AND ta.MENU_NAME LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchOption != null and searchOption.equals('userId')">
					AND ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<otherwise>
					AND (
							ta.MENU_NAME LIKE CONCAT('%', #{searchKeyword}, '%')
						OR
							ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
					)
				</otherwise>
			</choose>
		</if>
		ORDER BY REG_DATE ASC
		
	</select>
	
	<!-- 에러 로그 조회 -->
	<select id="findErrorLogView" parameterType="HashMap" resultType="logErrorViewRO" >
		SELECT  
			ta.SEQ,
			ta.URL, 
			ta.MENU_NAME, 
			ta.PARAM_JSON,
			ta.ERROR_MSG,
			ta.REG_USER_ID,
			CASE
				WHEN ta.REG_USER_ID is null then ''
				WHEN (SELECT count(1) from TAAA_ADMIN_USER WHERE USER_ID = ta.REG_USER_ID) = 0 then ''
				ELSE (SELECT NAME from TAAA_ADMIN_USER WHERE USER_ID = ta.REG_USER_ID)
			END as REG_USER_NAME,
<!-- 			(SELECT NAME from TAAA_ADMIN_USER WHERE USER_ID = ta.REG_USER_ID) as REG_USER_NAME, -->
			ta.IP,
			ta.REG_DATE 
		FROM TZCA_LOG_ERROR ta
		WHERE ta.SEQ = #{seq}
	</select>


	<delete id="deleteLogError" parameterType="HashMap">
		DELETE FROM TZCA_LOG_ERROR
		WHERE SEQ = #{seq}
	</delete>
	
	<select id="deleteCount" parameterType="HashMap" resultType="Integer">
		SELECT COUNT(1) CNT
		FROM TZCA_LOG_ERROR 
		WHERE  #{endDate} >= REG_DATE
		<if test="startDate !=null and ! startDate.equals('')">
		AND REG_DATE >= #{startDate}
		</if>
	</select>

	<delete id="deleteLogErrors" parameterType="HashMap">
		DELETE FROM TZCA_LOG_ERROR
		WHERE  #{endDate} >= REG_DATE
		<if test="startDate !=null and ! startDate.equals('')">
		AND REG_DATE >= #{startDate}
		</if>
	</delete>

</mapper>