<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seegene.web.repository.mariadb.DeviceLogMapper">

	<insert id="insertDeviceLog" parameterType="HashMap">
		INSERT INTO TZDA_LOG_DEVICE_INFO
			(
				SCREEN_WIDTH, 
				SCREEN_HEIGHT,
				OS,
				BROWSER,
				IP,
				<if test="regUserId !=null and ! regUserId.equals('')">
				REG_USER_ID, 
				</if>
				REG_DATE
			)
		VALUES(
			#{screenWidth},
			#{screenHeight},
			#{os},
			#{browser},
			#{ip},
			<if test="regUserId !=null and ! regUserId.equals('')">
			#{regUserId},
			</if>
			 now()
			)
	</insert>
	
	<insert id="insertTotalDeviceLog">
		INSERT INTO TZDB_LOG_DEVICE_TOTAL
			(
				LOG_YMD, 
				OS,
				BROWSER,
				SCREEN_WIDTH,
				SCREEN_HEIGHT,
				ACCESS_COUNT
			)
			SELECT 
				DATE_FORMAT(ta.REG_DATE, '%Y%m%d' ) as LOG_YMD, 
				ta.OS,
				ta.BROWSER,
				ta.SCREEN_WIDTH,
				ta.SCREEN_HEIGHT,
				COUNT(1) as ACCESS_COUNT
			FROM TZDA_LOG_DEVICE_INFO ta
			WHERE DATE_FORMAT(ta.REG_DATE, '%Y%m%d') = DATE_FORMAT(DATE_ADD(now(), INTERVAL -1 DAY), '%Y%m%d')
			GROUP BY ta.OS, ta.BROWSER, ta.SCREEN_WIDTH, ta.SCREEN_HEIGHT
	</insert>
	
		<!-- 접속 로그 리스트 -->
	<select id="findDeviceLogList" parameterType="HashMap" resultType="logDeviceInfoListRO" >
		SELECT @ROWNUM:=@ROWNUM+1 as row, 
			ta.SEQ,
			ta.IP, 
			ta.OS, 
			ta.BROWSER,
			ta.SCREEN_WIDTH,
			ta.SCREEN_HEIGHT,
			ta.REG_USER_ID,
			ta.REG_DATE 
		FROM TZDA_LOG_DEVICE_INFO ta,
		(SELECT @ROWNUM := #{offset}) TMP
		WHERE 1=1
		
		<if test="startDate !=null and ! startDate.equals('')">
		AND ta.REG_DATE >= #{startDate}
		</if>
		<if test="endDate !=null and ! endDate.equals('')">
		AND #{endDate} >= ta.REG_DATE
		</if>
		
		<if test="searchKeyword !=null and ! searchKeyword.equals('')">
			<choose>
				<when test="searchOption != null and searchOption.equals('userId')">
					AND ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchOption != null and searchOption.equals('ip')">
					AND ta.IP LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<otherwise>
					AND (
							ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
						OR
							ta.IP LIKE CONCAT('%', #{searchKeyword}, '%')
					)
				</otherwise>
			</choose>
		</if>
		ORDER BY REG_DATE DESC
		
		LIMIT #{limit} OFFSET #{offset}
	</select>
	
	<!-- 원클릭 건강정보 관리 리스트 카운트 -->
	<select id="countDeviceLogList" parameterType="HashMap" resultType="Integer">
		SELECT COUNT(1) CNT
		FROM TZDA_LOG_DEVICE_INFO ta
		WHERE  1=1
		<if test="startDate !=null and ! startDate.equals('')">
		AND ta.REG_DATE >= #{startDate}
		</if>
		<if test="endDate !=null and ! endDate.equals('')">
		AND #{endDate} >= ta.REG_DATE
		</if>
		<if test="searchKeyword !=null and ! searchKeyword.equals('')">
			<choose>
				<when test="searchOption != null and searchOption.equals('userId')">
					AND ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchOption != null and searchOption.equals('ip')">
					AND ta.IP LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<otherwise>
					AND (
							ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
						OR
							ta.IP LIKE CONCAT('%', #{searchKeyword}, '%')
					)
				</otherwise>
			</choose>
		</if>
	</select>
	
		<!-- 접속 로그 리스트 -->
	<select id="findDownloadDeviceLogList" parameterType="HashMap" resultType="logDeviceInfoVO" >
		SELECT 
			ta.SEQ,
			ta.IP, 
			ta.OS, 
			ta.BROWSER,
			ta.SCREEN_WIDTH,
			ta.SCREEN_HEIGHT,
			ta.REG_USER_ID,
			ta.REG_DATE 
		FROM TZDA_LOG_DEVICE_INFO ta
		WHERE 1=1
		
		<if test="startDate !=null and ! startDate.equals('')">
		AND ta.REG_DATE >= #{startDate}
		</if>
		<if test="endDate !=null and ! endDate.equals('')">
		AND #{endDate} >= ta.REG_DATE
		</if>
		
		<if test="searchKeyword !=null and ! searchKeyword.equals('')">
			<choose>
				<when test="searchOption != null and searchOption.equals('userId')">
					AND ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<when test="searchOption != null and searchOption.equals('ip')">
					AND ta.IP LIKE CONCAT('%', #{searchKeyword}, '%')
				</when>
				<otherwise>
					AND (
							ta.REG_USER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
						OR
							ta.IP LIKE CONCAT('%', #{searchKeyword}, '%')
					)
				</otherwise>
			</choose>
		</if>
		ORDER BY REG_DATE ASC
	</select>
	
	<select id="deleteCount" parameterType="HashMap" resultType="Integer">
		SELECT COUNT(1) CNT
		FROM TZDA_LOG_DEVICE_INFO 
		WHERE  #{endDate} >= REG_DATE
		<if test="startDate !=null and ! startDate.equals('')">
		AND REG_DATE >= #{startDate}
		</if>
	</select>

	<delete id="deleteLogDevice" parameterType="HashMap">
		DELETE FROM TZDA_LOG_DEVICE_INFO
		WHERE  #{endDate} >= REG_DATE
		<if test="startDate !=null and ! startDate.equals('')">
		AND REG_DATE >= #{startDate}
		</if>
	</delete>
	
	<select id="deviceStaticData" parameterType="HashMap" resultType="logDeviceStaticsRO">
		SELECT 
			ta.OS,
			ta.BROWSER,
			ta.SCREEN_WIDTH,
			ta.SCREEN_HEIGHT,
			SUM(ta.ACCESS_COUNT) as ACCESS_COUNT
		FROM TZDB_LOG_DEVICE_TOTAL ta
		WHERE DATE_FORMAT(ta.LOG_YMD,'%Y%m') = #{startDate}
		GROUP BY BROWSER, OS, SCREEN_WIDTH, SCREEN_HEIGHT
	</select>
	
	<select id="deviceStaticDataExcel" parameterType="HashMap" resultType="logDeviceStaticsRO">
		SELECT 
			ta.LOG_YMD, 
			ta.OS,
			ta.BROWSER,
			ta.SCREEN_WIDTH,
			ta.SCREEN_HEIGHT,
			ta.ACCESS_COUNT
		FROM TZDB_LOG_DEVICE_TOTAL ta
		WHERE ta.LOG_YMD >= #{startDate}
		AND #{endDate} >= ta.LOG_YMD 
		ORDER BY 1 ASC
	</select>

</mapper>